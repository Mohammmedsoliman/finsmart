<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinSmart - Reports</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style> body { font-family: 'Cairo', sans-serif; } </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="flex min-h-screen relative">
        <aside class="hidden md:flex w-64 bg-white border-e border-slate-200 p-6 flex-col gap-6 h-screen sticky top-0">
            <div class="flex items-center gap-2 font-bold text-indigo-600 text-2xl mb-2"><i data-lucide="wallet" class="w-8 h-8"></i> <span data-i18n="app_name">FinSmart</span></div>
            <nav class="flex flex-col gap-2">
                <a href="dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-500 hover:bg-indigo-50 hover:text-indigo-700 transition-colors"><i data-lucide="trending-up" class="w-5 h-5"></i> <span data-i18n="overview">Overview</span></a>
                <a href="insights.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-500 hover:bg-indigo-50 hover:text-indigo-700 transition-colors"><i data-lucide="alert-circle" class="w-5 h-5"></i> <span data-i18n="insights">Insights</span></a>
                <a href="transactions.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-500 hover:bg-indigo-50 hover:text-indigo-700 transition-colors"><i data-lucide="wallet" class="w-5 h-5"></i> <span data-i18n="transactions">Transactions</span></a>
                <a href="inventory.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-500 hover:bg-indigo-50 hover:text-indigo-700 transition-colors"><i data-lucide="package" class="w-5 h-5"></i> <span data-i18n="inventory">Inventory</span></a>
                <a href="reports.html" class="flex items-center gap-3 px-4 py-3 rounded-lg bg-indigo-50 text-indigo-700 font-medium"><i data-lucide="bar-chart-2" class="w-5 h-5"></i> <span data-i18n="reports">Reports</span></a>
            </nav>
            <div class="mt-auto p-4 bg-indigo-50 rounded-xl">
                <button id="lang-toggle" class="text-xs text-slate-600 border border-slate-300 px-2 py-1 rounded mt-2 w-full hover:bg-white transition">English</button>
            </div>
        </aside>

        <main class="flex-1 p-4 md:p-8 max-w-6xl mx-auto w-full">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-slate-900" data-i18n="reports">Financial Reports</h1>
                    <p class="text-slate-500" data-i18n="overview">Business Performance</p>
                </div>
                <button onclick="downloadReport()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 shadow-lg shadow-indigo-200 transition">
                    <i data-lucide="download" class="w-4 h-4"></i> Download PDF
                </button>
            </div>

            <div id="report-content">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <p class="text-slate-500 text-sm font-medium" data-i18n="total_income">Total Revenue</p>
                        <h3 class="text-3xl font-bold text-emerald-600 mt-2" id="total-revenue">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <p class="text-slate-500 text-sm font-medium" data-i18n="net_profit">Net Profit</p>
                        <h3 class="text-3xl font-bold text-indigo-600 mt-2" id="net-profit">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <p class="text-slate-500 text-sm font-medium">Profit Margin</p>
                        <h3 class="text-3xl font-bold text-slate-800 mt-2" id="profit-margin">0%</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-slate-700 mb-4">Monthly Income vs Expense</h3>
                        <div class="relative h-64 w-full">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-slate-700 mb-4">Expenses by Category</h3>
                        <div class="relative h-64 w-full flex justify-center">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b border-slate-100">
                        <h3 class="font-bold text-slate-800">Top Categories</h3>
                    </div>
                    <table class="w-full text-start">
                        <thead class="bg-slate-50 text-slate-500 text-sm">
                            <tr>
                                <th class="p-4 text-start" data-i18n="category">Category</th>
                                <th class="p-4 text-end" data-i18n="total_income">Total Income</th>
                                <th class="p-4 text-end">Performance</th>
                            </tr>
                        </thead>
                        <tbody id="top-categories-list">
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        import { auth, db } from '../js/firebase.js';
        import { initLanguage, changeLanguage, t } from '../js/translations.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            initLanguage();
            lucide.createIcons();
        });

        document.getElementById('lang-toggle').addEventListener('click', () => {
            const current = localStorage.getItem('finsmart_lang') || 'ar';
            changeLanguage(current === 'ar' ? 'en' : 'ar');
            location.reload(); 
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                generateReports(user.uid);
            } else {
                window.location.href = "login.html";
            }
        });

        // ðŸŸ¢ Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± PDF
        window.downloadReport = function() {
            const element = document.getElementById('report-content');
            const opt = {
                margin: 10,
                filename: 'FinSmart_Business_Report.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        async function generateReports(userId) {
            const q = query(collection(db, "transactions"), where("userId", "==", userId));
            
            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) return;

                let transactions = [];
                snapshot.forEach((doc) => transactions.push(doc.data()));

                transactions.sort((a, b) => (a.date?.seconds || 0) - (b.date?.seconds || 0));

                let monthlyData = {}; 
                let categoryExpenses = {};
                let categoryIncome = {};
                let totalRev = 0;
                let totalExp = 0;

                transactions.forEach(data => {
                    const date = data.date ? new Date(data.date.seconds * 1000) : new Date();
                    const monthKey = date.toLocaleString('default', { month: 'short', year: 'numeric' });

                    if (!monthlyData[monthKey]) monthlyData[monthKey] = { income: 0, expense: 0 };

                    if (data.type === "INCOME") {
                        monthlyData[monthKey].income += data.amount;
                        totalRev += data.amount;
                        const cat = data.category || "General";
                        if (!categoryIncome[cat]) categoryIncome[cat] = 0;
                        categoryIncome[cat] += data.amount;
                    } else {
                        monthlyData[monthKey].expense += data.amount;
                        totalExp += data.amount;
                        const cat = data.category || "General";
                        if (!categoryExpenses[cat]) categoryExpenses[cat] = 0;
                        categoryExpenses[cat] += data.amount;
                    }
                });

                const currency = t("currency");
                document.getElementById('total-revenue').innerText = totalRev.toLocaleString() + " " + currency;
                const net = totalRev - totalExp;
                document.getElementById('net-profit').innerText = net.toLocaleString() + " " + currency;
                
                const margin = totalRev > 0 ? ((net / totalRev) * 100).toFixed(1) : 0;
                document.getElementById('profit-margin').innerText = margin + "%";
                document.getElementById('net-profit').className = net >= 0 ? "text-3xl font-bold text-emerald-600 mt-2" : "text-3xl font-bold text-red-600 mt-2";

                const labels = Object.keys(monthlyData);
                const incomeData = labels.map(m => monthlyData[m].income);
                const expenseData = labels.map(m => monthlyData[m].expense);

                const ctx1 = document.getElementById('monthlyChart');
                new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: t("income"), data: incomeData, backgroundColor: '#10b981', borderRadius: 4 },
                            { label: t("expense"), data: expenseData, backgroundColor: '#ef4444', borderRadius: 4 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                const expLabels = Object.keys(categoryExpenses);
                const expValues = Object.values(categoryExpenses);
                
                const ctx2 = document.getElementById('categoryChart');
                new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: expLabels,
                        datasets: [{
                            data: expValues,
                            backgroundColor: ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6'],
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                const topList = document.getElementById('top-categories-list');
                const sortedIncome = Object.entries(categoryIncome).sort((a, b) => b[1] - a[1]);

                if(sortedIncome.length === 0) {
                    topList.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-slate-400">${t("no_data")}</td></tr>`;
                } else {
                    topList.innerHTML = sortedIncome.map(([cat, amount]) => {
                        const percent = totalRev > 0 ? ((amount / totalRev) * 100).toFixed(1) : 0;
                        return `
                            <tr class="border-b border-slate-50 last:border-0 hover:bg-slate-50">
                                <td class="p-4 font-medium text-slate-700 text-start">${cat}</td>
                                <td class="p-4 text-end font-bold text-emerald-600">${amount.toLocaleString()}</td>
                                <td class="p-4 text-end">
                                    <span class="bg-indigo-50 text-indigo-700 text-xs px-2 py-1 rounded-full font-bold">${percent}%</span>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }

            } catch (error) {
                console.error("Error loading reports:", error);
            }
        }
    </script>
</body>
</html>