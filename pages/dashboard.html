<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinSmart - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } #sidebar { transition: transform 0.3s ease-in-out; } </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <header class="bg-white border-b border-slate-200 p-4 sticky top-0 z-20 flex justify-between items-center md:hidden">
        <div class="flex items-center gap-2 font-bold text-indigo-600 text-xl"><i data-lucide="wallet" class="w-6 h-6"></i> FinSmart</div>
        <button id="menu-btn" class="p-2"><i data-lucide="menu" class="w-6 h-6 text-slate-600"></i></button>
    </header>

    <div class="flex min-h-screen relative">
        <aside id="sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 w-64 bg-white border-r border-slate-200 p-6 flex flex-col gap-6 z-30 h-screen transition-transform duration-300">
            <div class="hidden md:flex items-center gap-2 font-bold text-indigo-600 text-2xl mb-2"><i data-lucide="wallet" class="w-8 h-8"></i> FinSmart</div>
            <nav class="flex flex-col gap-2">
                <a href="dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-lg bg-indigo-50 text-indigo-700 font-medium"><i data-lucide="trending-up" class="w-5 h-5"></i> <span>Overview</span></a>
                <a href="insights.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-500 hover:bg-slate-50 hover:text-slate-900 transition-colors"><i data-lucide="alert-circle" class="w-5 h-5"></i> <span>Insights</span></a>
                <a href="transactions.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-500 hover:bg-slate-50 hover:text-slate-900 transition-colors"><i data-lucide="wallet" class="w-5 h-5"></i> <span>Transactions</span></a>
                <a href="inventory.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-500 hover:bg-slate-50 hover:text-slate-900 transition-colors"><i data-lucide="package" class="w-5 h-5"></i> <span>Inventory</span></a>
                <a href="reports.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-500 hover:bg-indigo-50 hover:text-indigo-700 transition-colors">
                <i data-lucide="bar-chart-2" class="w-5 h-5"></i> <span>Reports</span></a>
            </nav>
            <div class="mt-auto p-4 bg-indigo-50 rounded-xl">
                <p class="text-sm text-indigo-800 font-medium">Pro Plan</p>
                <button id="logout-btn" class="text-xs text-indigo-600 underline mt-1 hover:text-indigo-800 cursor-pointer">Log Out</button>
            </div>
        </aside>

        <div id="overlay" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden"></div>

        <main class="flex-1 p-4 md:p-8 max-w-5xl mx-auto w-full">
            <div class="mb-6 mt-4 md:mt-0">
                <h1 id="user-greeting" class="text-2xl md:text-3xl font-bold text-slate-900">Good Morning ğŸ‘‹</h1>
                <p class="text-slate-500">Here is what's happening with your business today.</p>
            </div>

            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-5 text-white shadow-lg mb-8 flex flex-col md:flex-row justify-between items-center relative overflow-hidden">
                <div class="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
                
                <div class="relative z-10 mb-4 md:mb-0">
                    <h2 class="text-lg font-bold flex items-center gap-2"><i data-lucide="calendar" class="w-5 h-5"></i> Today's Summary</h2>
                    <p id="daily-summary-text" class="text-indigo-100 mt-1 text-sm font-medium">Loading activity...</p>
                </div>

                <div class="flex gap-6 relative z-10">
                    <div class="text-center">
                        <p class="text-xs text-indigo-200 mb-1">Highest Expense</p>
                        <p id="daily-high-expense" class="font-bold text-lg text-white">-</p>
                    </div>
                    <div class="w-px bg-indigo-400 h-10"></div>
                    <div class="text-center">
                        <p class="text-xs text-indigo-200 mb-1">Highest Income</p>
                        <p id="daily-high-income" class="font-bold text-lg text-emerald-300">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg border border-indigo-100 p-2 mb-10 relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                <div class="p-4">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Add Transaction (Text, Voice, or Image)</label>
                    <textarea id="magic-input" placeholder="Ù…Ø«Ø§Ù„: 'Ø¯ÙØ¹Øª 200 ØºØ¯Ø§Ø¡ Ø¹Ù…Ù„' Ø£Ùˆ 'ÙØ§ØªÙˆØ±Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¡ 500'..." class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none h-24 text-slate-700 transition-all"></textarea>
                    <div class="flex justify-between items-center mt-3">
                        <div class="flex gap-2">
                            <button class="flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 rounded-lg text-slate-600 text-sm hover:bg-slate-50"><i data-lucide="mic" class="w-4 h-4"></i> <span class="hidden sm:inline">Voice</span></button>
                            <button class="flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 rounded-lg text-slate-600 text-sm hover:bg-slate-50"><i data-lucide="camera" class="w-4 h-4"></i> <span class="hidden sm:inline">Scan</span></button>
                        </div>
                        <button onclick="analyzeInput()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium flex items-center gap-2 transition-transform active:scale-95 shadow-md shadow-indigo-200">Analyze <i data-lucide="send" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>

            <div id="metrics-container" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"></div>
            
            <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="sparkles" class="w-5 h-5 text-indigo-500"></i> AI Observations</h2>
            <div id="alerts-container" class="grid gap-3"></div>
        </main>
    </div>

    <script type="module">
        import { auth, db } from '../js/firebase.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, addDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                if(user.displayName) document.getElementById('user-greeting').innerText = `Good Morning, ${user.displayName.split(' ')[0]} ğŸ‘‹`;
                loadDashboardData(user.uid);
            } else {
                window.location.href = "login.html";
            }
        });

        // ğŸ§  Ø¯Ø§Ù„Ø© ØªØµÙ†ÙŠÙ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
        function detectCategory(text) {
            const t = text.toLowerCase();
            if (t.includes('Ø·Ø¹Ø§Ù…') || t.includes('Ø§ÙƒÙ„') || t.includes('Ù…Ø·Ø¹Ù…') || t.includes('food') || t.includes('ØºØ¯Ø§Ø¡') || t.includes('Ø¹Ø´Ø§Ø¡')) return 'Food';
            if (t.includes('Ù…ÙˆØ§ØµÙ„Ø§Øª') || t.includes('ØªØ§ÙƒØ³ÙŠ') || t.includes('Ø§ÙˆØ¨Ø±') || t.includes('uber') || t.includes('transport') || t.includes('Ø¨Ù†Ø²ÙŠÙ†')) return 'Transport';
            if (t.includes('ÙØ§ØªÙˆØ±Ø©') || t.includes('ÙƒÙ‡Ø±Ø¨Ø§Ø¡') || t.includes('Ù†Øª') || t.includes('bill') || t.includes('Ø§ÙŠØ¬Ø§Ø±')) return 'Bills';
            if (t.includes('Ø±Ø§ØªØ¨') || t.includes('Ù‚Ø¨Ø¶') || t.includes('salary')) return 'Salary';
            if (t.includes('Ø¨Ø¶Ø§Ø¹Ø©') || t.includes('ØªÙˆØ±ÙŠØ¯') || t.includes('Ø®Ø§Ù…Ø§Øª')) return 'Inventory';
            return 'General';
        }

        window.analyzeInput = async function() {
            const input = document.getElementById('magic-input');
            const text = input.value.trim();
            const btn = document.querySelector('button[onclick="analyzeInput()"]');
            
            if(text === "") { alert("Please type something!"); return; }

            const amountMatch = text.match(/\d+/); 
            const amount = amountMatch ? parseFloat(amountMatch[0]) : 0;
            const isExpense = text.includes("Ø¯ÙØ¹") || text.includes("Ø´Ø±Ø§Ø¡") || text.includes("ØµØ±Ù") || text.includes("paid") || text.includes("buy");
            const type = isExpense ? "EXPENSE" : "INCOME";
            const category = detectCategory(text);

            btn.innerText = "Saving...";
            btn.disabled = true;

            try {
                await addDoc(collection(db, "transactions"), {
                    userId: currentUser.uid,
                    text: text,
                    amount: amount,
                    type: type,
                    category: category,
                    date: serverTimestamp()
                });

                alert(`ØªÙ… Ø§Ù„Ø­ÙØ¸!\nØ§Ù„ØªØµÙ†ÙŠÙ: ${category}\nØ§Ù„Ù…Ø¨Ù„Øº: ${amount}`);
                input.value = "";
                loadDashboardData(currentUser.uid); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙˆØ±Ø§Ù‹

            } catch (error) {
                console.error("Error:", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");
            } finally {
                btn.innerHTML = `Analyze <i data-lucide="send" class="w-4 h-4"></i>`;
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        async function loadDashboardData(userId) {
            const q = query(collection(db, "transactions"), where("userId", "==", userId));
            try {
                const querySnapshot = await getDocs(q);
                let totalIncome = 0;
                let totalExpense = 0;
                
                // ğŸŸ¢ Ù…ØªØºÙŠØ±Ø§Øª Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…
                let todayIncome = 0;
                let todayExpense = 0;
                let todayCount = 0;
                let maxExpenseToday = 0;
                let maxIncomeToday = 0;

                // ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… (Ø¨Ø¯ÙˆÙ† ÙˆÙ‚Øª) Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
                const today = new Date();
                today.setHours(0,0,0,0);

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª (Ù„Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø³ÙÙ„ÙŠØ©)
                    if (data.type === "INCOME") totalIncome += data.amount;
                    else totalExpense += data.amount;

                    // 2. Ø­Ø³Ø§Ø¨ Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…
                    if(data.date) {
                        const txDate = new Date(data.date.seconds * 1000);
                        txDate.setHours(0,0,0,0); // ØªØµÙÙŠØ± Ø§Ù„ÙˆÙ‚Øª Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©

                        if(txDate.getTime() === today.getTime()) {
                            todayCount++;
                            if (data.type === "INCOME") {
                                todayIncome += data.amount;
                                if(data.amount > maxIncomeToday) maxIncomeToday = data.amount;
                            } else {
                                todayExpense += data.amount;
                                if(data.amount > maxExpenseToday) maxExpenseToday = data.amount;
                            }
                        }
                    }
                });

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ Metrics
                updateMetricCard(0, totalIncome);
                updateMetricCard(1, totalExpense);
                updateMetricCard(2, totalIncome - totalExpense);

                // ğŸ†• ØªØ­Ø¯ÙŠØ« ÙƒØ§Ø±Øª "Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…" Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const todayProfit = todayIncome - todayExpense;
                const profitSign = todayProfit >= 0 ? "+" : "";
                
                document.getElementById('daily-summary-text').innerText = `${todayCount} Transactions today â€“ Profit: ${profitSign}${todayProfit} EGP`;
                document.getElementById('daily-high-expense').innerText = maxExpenseToday > 0 ? `-${maxExpenseToday}` : "-";
                document.getElementById('daily-high-income').innerText = maxIncomeToday > 0 ? `+${maxIncomeToday}` : "-";

            } catch (error) { console.error(error); }
        }

        function updateMetricCard(index, value) {
            const cards = document.querySelectorAll('#metrics-container h3');
            if(cards[index]) cards[index].innerText = `${value} EGP`;
        }

        const logoutBtn = document.getElementById('logout-btn');
        if(logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                await signOut(auth);
                window.location.href = "login.html";
            });
        }
    </script>

    <script>
        const metricsData = [
            { title: "Total Income", value: "...", trend: "Loading...", status: "good" },
            { title: "Total Expenses", value: "...", trend: "Loading...", status: "neutral" },
            { title: "Net Profit", value: "...", trend: "Loading...", status: "good" }
        ];

        function renderMetrics() {
            const container = document.getElementById('metrics-container');
            if(container) container.innerHTML = metricsData.map(m => `<div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm"><p class="text-slate-500 text-sm font-medium">${m.title}</p><div class="flex items-end justify-between mt-2"><h3 class="text-3xl font-bold text-slate-800">${m.value}</h3><span class="text-sm font-medium px-2 py-1 rounded-full bg-slate-100 text-slate-600">--</span></div></div>`).join('');
        }

        const alertsData = [{ text: "Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø°ÙƒÙŠ ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† âœ…", type: "info" }];
        function renderAlerts() {
            const container = document.getElementById('alerts-container');
            if(container) container.innerHTML = alertsData.map(a => `<div class="bg-white border-l-4 border-blue-400 p-4 rounded-r-xl shadow-sm flex items-start gap-3"><i data-lucide="info" class="w-5 h-5 text-blue-500 flex-shrink-0 mt-0.5"></i><p class="text-slate-700">${a.text}</p></div>`).join('');
        }

        const menuBtn = document.getElementById('menu-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        function toggleSidebar() {
            const isClosed = sidebar.classList.contains('-translate-x-full');
            if (isClosed) { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); } 
            else { sidebar.classList.add('-translate-x-full'); overlay.classList.add('hidden'); }
        }
        if(menuBtn) menuBtn.addEventListener('click', toggleSidebar);
        if(overlay) overlay.addEventListener('click', toggleSidebar);

        document.addEventListener('DOMContentLoaded', () => { renderMetrics(); renderAlerts(); lucide.createIcons(); });
    </script>
</body>
</html>